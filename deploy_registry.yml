---
- name: Play to populate image_hashes for relevant images
  hosts: localhost
  vars:
    images_to_get_hash_for:
      release:
        image: quay.io/openshift-release-dev/ocp-release
        tag: "{{ release_tag | default(openshift_full_version + '-x86_64') }}"
      controller:
        image: quay.io/ocpmetal/assisted-installer-controller
        tag: "{{ controller_tag | default('latest') }}"
      installer_agent:
        image: quay.io/ocpmetal/assisted-installer-agent
        tag: "{{ installer_agent_tag | default('latest') }}"
      installer:
        image: quay.io/ocpmetal/assisted-installer
        tag: "{{ installer_tag | default('latest') }}"
  roles:
    - get_image_hash
  post_tasks:
    - name: Set image hashes in registry_host
      set_fact:
        image_hashes: "{{ image_hashes }}"
      delegate_to: registry_host
      delegate_facts: true


- name: Play to install and setup mirror registry
  hosts: registry_host
  vars:
    downloads_path: /tmp/wip
    config_file_path: /tmp/wip/config
  roles:
    - setup_selfsigned_cert
    - setup_mirror_registry
